- name: Virtual Machine for Azure
  hosts: localhost
  connection: local
  tasks:
  - name: Resource Group for Nucypher nodes (deployment location is determined below)
    azure_rm_resourcegroup:
      name: nucypher_rg1
      location: westcentralus
  - name: Virtual Network
    azure_rm_virtualnetwork:
      resource_group: nucypher_rg1
      name: nucypher_vnet1
      address_prefixes: "10.0.0.0/16"
  - name: Subnet
    azure_rm_subnet:
      resource_group: nucypher_rg1
      name: nucypher_subnet1
      address_prefix: "10.0.1.0/24"
      virtual_network: nucypher_vnet1
  - name: Create public IP address
    azure_rm_publicipaddress:
      resource_group: nucypher_rg1
      allocation_method: Static
      name: nucypher_vm1_ip1
    register: output_ip_address
  - name: View Public IP which will be created for the VM
    debug:
      msg: "The nucypher VM IP is: {{ output_ip_address.state.ip_address }}."
  - name: Allow SSH and Nucypher communication ports in network security group
    azure_rm_securitygroup:
      resource_group: nucypher_rg1
      name: nucypher_nsg1
      rules:
        - name: SSH
          protocol: Tcp
          destination_port_range: 22
          access: Allow
          priority: 1001
          direction: Inbound
        - name: nucypher_inbound
          protocol: Tcp
          destination_port_range: 9151
          access: Allow
          priority: 1002
          direction: Inbound
        - name: nucypher_outbound
          protocol: Tcp
          destination_port_range: 9151
          access: Allow
          priority: 3002
          direction: outbound
  - name: Virtual Network VM NIC
    azure_rm_networkinterface:
      resource_group: nucypher_rg1
      name: nucypher_vm1_nic1
      virtual_network: nucypher_vnet1
      subnet: nucypher_subnet1
      public_ip_name: nucypher_vm1_ip1
      security_group: nucypher_nsg1
  - name: Create VM
    azure_rm_virtualmachine:
      resource_group: nucypher_rg1
      name: nucypher_vm1
      vm_size: Standard_B1s
      admin_username: azureuser
      ssh_password_enabled: false
      ssh_public_keys:
        - path: /home/azureuser/.ssh/authorized_keys
          key_data: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCjvwylmZfw3zLszsHEimxsKXHCg/Ph1D+8Du+Q+Tnf54b8xLfJB1CqpNI3dz8oDfbd72NSUcw4uHxpO+B6u15H7vxq5naQOCEtzSQMObMfQXFfzvqAfEL8XhRsnltWFut8uKwnsnZCwreCbrIFmV74UdqIcdG9FUyaHUtzszlA8siHUjx0SHZfCFmmPoMIPWKq2wLzcpSC9gDK4dVayxPC1JJlxvwd0BDjf69uFwNbKs4N+SFrrvR4jmMQk5BZL479JIegGd4TbxMY7kkR/LqrfxI3wnB5xgLcnUkSEI8Tsg3n/zxqMuZxl5lygFU4rEBX3QQKTyk3mO1VUMLPc5F3 smikha
      network_interfaces: nucypher_vm1_nic1
      image:
        offer: UbuntuServer
        publisher: Canonical
        sku: 16.04-LTS
        version: latest
